<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bike Booking Payment Test</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        max-width: 600px;
        width: 100%;
      }

      .header {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 30px 20px;
        text-align: center;
      }

      .header h1 {
        margin-bottom: 10px;
        font-size: 28px;
      }

      .header p {
        opacity: 0.9;
      }

      .form-section {
        padding: 30px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }

      input[type="text"],
      input[type="number"],
      input[type="datetime-local"],
      select,
      textarea {
        width: 100%;
        padding: 15px;
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        font-size: 16px;
        transition: border-color 0.3s ease;
      }

      input[type="text"]:focus,
      input[type="number"]:focus,
      input[type="datetime-local"]:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #4caf50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
      }

      .checkbox-group input[type="checkbox"] {
        width: auto;
        margin: 0;
      }

      .bike-info {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
      }

      .bike-info h3 {
        color: #333;
        margin-bottom: 10px;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        padding: 5px 0;
      }

      .amount-display {
        font-size: 24px;
        font-weight: bold;
        color: #4caf50;
        text-align: center;
        padding: 20px;
        background: #f0f8f0;
        border-radius: 10px;
        margin-bottom: 25px;
      }

      .btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(76, 175, 80, 0.3);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .status-page {
        display: none;
        text-align: center;
        padding: 50px 30px;
      }

      .success-icon {
        font-size: 80px;
        color: #4caf50;
        margin-bottom: 20px;
      }

      .failure-icon {
        font-size: 80px;
        color: #f44336;
        margin-bottom: 20px;
      }

      .status-title {
        font-size: 28px;
        margin-bottom: 15px;
        font-weight: 600;
      }

      .success-title {
        color: #4caf50;
      }

      .failure-title {
        color: #f44336;
      }

      .status-message {
        font-size: 16px;
        color: #666;
        margin-bottom: 30px;
        line-height: 1.5;
      }

      .transaction-details {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        text-align: left;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #5a6268);
      }

      .loading {
        display: none;
        text-align: center;
        padding: 30px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4caf50;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .vehicle-selection {
        border: 2px solid #e1e5e9;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: border-color 0.3s ease;
      }

      .vehicle-selection:hover {
        border-color: #4caf50;
      }

      .vehicle-selection.selected {
        border-color: #4caf50;
        background: #f0f8f0;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Booking Form -->
      <div id="bookingForm">
        <div class="header">
          <h1>üèçÔ∏è Book Your Royal Enfield</h1>
          <p>Complete your booking with secure payment</p>
        </div>

        <div class="form-section">
          <form id="bikeBookingForm">
            <!-- User ID -->
            <div class="form-group">
              <label for="userId">User ID:</label>
              <input
                type="text"
                id="userId"
                value="USR1754833148052000"
                required
              />
            </div>

            <!-- Vehicle Selection -->
            <div class="form-group">
              <label>Select Vehicle:</label>
              <div
                class="vehicle-selection"
                data-vehicle-id="VEH1756642168273000"
                data-bike-id="BIKE1756642168272000"
                data-vehicle-number="KA01AB1234"
                data-location="Bangalore Main Branch"
                data-condition="EXCELLENT"
              >
                <input
                  type="radio"
                  name="vehicle"
                  value="VEH1756307559619000"
                  id="vehicle1"
                  style="margin-right: 10px"
                />
                <label for="vehicle1" style="display: inline; margin: 0">
                  <strong>KA01AB1234</strong> - Royal Enfield Himalayan 411<br />
                  <small
                    >Bangalore Main Branch ‚Ä¢ Excellent Condition ‚Ä¢
                    ‚Çπ2500/day</small
                  >
                </label>
              </div>
              <div
                class="vehicle-selection"
                data-vehicle-id="VEH1756307559619001"
                data-bike-id="BIKE1756400843175000"
                data-vehicle-number="KA02CD5678"
                data-location="Bangalore HSR Branch"
                data-condition="GOOD"
              >
                <input
                  type="radio"
                  name="vehicle"
                  value="VEH1756307559619001"
                  id="vehicle2"
                  style="margin-right: 10px"
                />
                <label for="vehicle2" style="display: inline; margin: 0">
                  <strong>KA02CD5678</strong> - Royal Enfield Himalayan 411<br />
                  <small
                    >Bangalore HSR Branch ‚Ä¢ Good Condition ‚Ä¢ ‚Çπ2500/day</small
                  >
                </label>
              </div>
            </div>

            <!-- Date Selection -->
            <div class="form-row">
              <div class="form-group">
                <label for="fromDate">From Date:</label>
                <input type="datetime-local" id="fromDate" required />
              </div>
              <div class="form-group">
                <label for="toDate">To Date:</label>
                <input type="datetime-local" id="toDate" required />
              </div>
            </div>

            <!-- Additional Features -->
            <div class="form-group">
              <label>Additional Features:</label>

              <div class="form-row">
                <div class="form-group">
                  <label for="pickupLocation">Pickup Location:</label>
                  <input
                    type="text"
                    id="pickupLocation"
                    placeholder="Enter pickup location"
                  />
                </div>
                <div class="form-group">
                  <label for="dropLocation">Drop Location:</label>
                  <input
                    type="text"
                    id="dropLocation"
                    placeholder="Enter drop location"
                  />
                </div>
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="insuranceIncluded" />
                <label for="insuranceIncluded"
                  >Include Insurance (+‚Çπ200/day)</label
                >
              </div>

              <div class="checkbox-group">
                <input type="checkbox" id="deliveryRequired" />
                <label for="deliveryRequired"
                  >Home Delivery Required (+‚Çπ500)</label
                >
              </div>

              <div
                class="form-group"
                id="deliveryAddressGroup"
                style="display: none"
              >
                <label for="deliveryAddress">Delivery Address:</label>
                <textarea
                  id="deliveryAddress"
                  rows="3"
                  placeholder="Enter delivery address"
                ></textarea>
              </div>

              <div class="form-group">
                <label for="emergencyContact">Emergency Contact:</label>
                <input
                  type="text"
                  id="emergencyContact"
                  placeholder="Enter emergency contact number"
                />
              </div>

              <div class="form-group">
                <label for="specialRequests">Special Requests:</label>
                <textarea
                  id="specialRequests"
                  rows="3"
                  placeholder="Any special requirements or notes"
                ></textarea>
              </div>

              <div class="form-group">
                <label for="customerNotes">Customer Notes:</label>
                <textarea
                  id="customerNotes"
                  rows="3"
                  placeholder="Additional notes for your booking"
                ></textarea>
              </div>
            </div>

            <div class="bike-info" id="bikeInfo" style="display: none">
              <h3>Booking Summary</h3>
              <div class="info-row">
                <span>Bike Model:</span>
                <span id="selectedBikeName">Royal Enfield Himalayan 411</span>
              </div>
              <div class="info-row">
                <span>Vehicle Number:</span>
                <span id="displayVehicleNumber"></span>
              </div>
              <div class="info-row">
                <span>Location:</span>
                <span id="displayLocation"></span>
              </div>
              <div class="info-row">
                <span>Daily Rate:</span>
                <span id="dailyRate">‚Çπ2500</span>
              </div>
              <div class="info-row">
                <span>Duration:</span>
                <span id="displayDuration"></span>
              </div>
              <div class="info-row">
                <span>Insurance:</span>
                <span id="displayInsurance">Not included</span>
              </div>
              <div class="info-row">
                <span>Delivery:</span>
                <span id="displayDelivery">Not required</span>
              </div>
            </div>

            <div class="amount-display" id="amountDisplay">
              Total Amount: ‚Çπ<span id="totalAmount">0</span>
            </div>

            <button type="submit" class="btn" id="payNowBtn">
              Pay Now & Book Bike
            </button>
          </form>
        </div>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="loading">
        <div class="spinner"></div>
        <h3>Processing your payment...</h3>
        <p>Please wait while we confirm your booking</p>
      </div>

      <!-- Success Page -->
      <div id="successPage" class="status-page">
        <div class="success-icon">‚úÖ</div>
        <h2 class="status-title success-title">Booking Confirmed!</h2>
        <p class="status-message">
          Your bike has been successfully booked. You'll receive a confirmation
          email shortly.
        </p>

        <div class="transaction-details">
          <h3>Booking Details</h3>
          <div class="info-row">
            <span>Booking ID:</span>
            <span id="successBookingId">-</span>
          </div>
          <div class="info-row">
            <span>Payment ID:</span>
            <span id="successPaymentId">-</span>
          </div>
          <div class="info-row">
            <span>Bike Model:</span>
            <span id="successBikeModel">-</span>
          </div>
          <div class="info-row">
            <span>Vehicle Number:</span>
            <span id="successVehicleNumber">-</span>
          </div>
          <div class="info-row">
            <span>Amount Paid:</span>
            <span id="successAmount">-</span>
          </div>
        </div>

        <button onclick="resetForm()" class="btn">Book Another Bike</button>
      </div>

      <!-- Failure Page -->
      <div id="failurePage" class="status-page">
        <div class="failure-icon">‚ùå</div>
        <h2 class="status-title failure-title">Payment Failed</h2>
        <p class="status-message">
          Sorry, we couldn't process your payment. Please try again or contact
          support if the issue persists.
        </p>

        <div class="transaction-details">
          <h3>Error Details</h3>
          <div class="info-row">
            <span>Error:</span>
            <span id="errorMessage">Payment processing failed</span>
          </div>
          <div class="info-row">
            <span>Suggested Action:</span>
            <span>Try again or use a different payment method</span>
          </div>
        </div>

        <button onclick="resetForm()" class="btn">Try Again</button>
        <button
          onclick="window.location.href='mailto:support@bikebooking.com'"
          class="btn btn-secondary"
          style="margin-top: 10px"
        >
          Contact Support
        </button>
      </div>
    </div>

    <script>
      // Configuration
      const API_BASE_URL = "http://localhost:8000/api"; // Change this to your API URL
      const RAZORPAY_KEY = "rzp_test_RZ4yu67jLQUpuF"; // Your Razorpay test key

      // Vehicle and pricing data
      const bikeData = {
        basePrice: 2500,
        weekendMultiplier: 1.8,
        insurancePerDay: 200,
        deliveryCharge: 500,
      };

      // DOM elements
      const form = document.getElementById("bikeBookingForm");
      const vehicleSelections = document.querySelectorAll(
        'input[name="vehicle"]'
      );
      const fromDateInput = document.getElementById("fromDate");
      const toDateInput = document.getElementById("toDate");
      const deliveryRequiredCheckbox =
        document.getElementById("deliveryRequired");
      const deliveryAddressGroup = document.getElementById(
        "deliveryAddressGroup"
      );
      const insuranceCheckbox = document.getElementById("insuranceIncluded");

      // Set default dates
      const now = new Date();
      const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      fromDateInput.value = now.toISOString().slice(0, 16);
      toDateInput.value = tomorrow.toISOString().slice(0, 16);

      // Event listeners
      vehicleSelections.forEach((radio) => {
        radio.addEventListener("change", function () {
          // Update vehicle selection styling
          document.querySelectorAll(".vehicle-selection").forEach((div) => {
            div.classList.remove("selected");
          });
          this.closest(".vehicle-selection").classList.add("selected");
          updateBookingSummary();
        });
      });

      fromDateInput.addEventListener("change", updateBookingSummary);
      toDateInput.addEventListener("change", updateBookingSummary);
      insuranceCheckbox.addEventListener("change", updateBookingSummary);
      deliveryRequiredCheckbox.addEventListener("change", function () {
        deliveryAddressGroup.style.display = this.checked ? "block" : "none";
        updateBookingSummary();
      });

      // Update booking summary
      function updateBookingSummary() {
        const selectedVehicle = document.querySelector(
          'input[name="vehicle"]:checked'
        );
        if (!selectedVehicle) {
          document.getElementById("bikeInfo").style.display = "none";
          document.getElementById("totalAmount").textContent = "0";
          return;
        }

        const vehicleDiv = selectedVehicle.closest(".vehicle-selection");
        const vehicleNumber = vehicleDiv.dataset.vehicleNumber;
        const location = vehicleDiv.dataset.location;

        const fromDate = new Date(fromDateInput.value);
        const toDate = new Date(toDateInput.value);

        if (fromDate >= toDate) {
          document.getElementById("bikeInfo").style.display = "none";
          document.getElementById("totalAmount").textContent = "0";
          return;
        }

        const timeDiff = toDate.getTime() - fromDate.getTime();
        const days = Math.ceil(timeDiff / (1000 * 3600 * 24));

        // Calculate pricing
        let dailyRate = bikeData.basePrice;

        // Check if it includes weekend days (simplified - just check if more than 2 days includes weekend)
        const isWeekend =
          days > 2 ||
          fromDate.getDay() === 0 ||
          fromDate.getDay() === 6 ||
          toDate.getDay() === 0 ||
          toDate.getDay() === 6;
        if (isWeekend) {
          dailyRate = Math.round(
            bikeData.basePrice * bikeData.weekendMultiplier
          );
        }

        let totalAmount = dailyRate * days;

        if (insuranceCheckbox.checked) {
          totalAmount += bikeData.insurancePerDay * days;
        }

        if (deliveryRequiredCheckbox.checked) {
          totalAmount += bikeData.deliveryCharge;
        }

        // Update display
        document.getElementById("displayVehicleNumber").textContent =
          vehicleNumber;
        document.getElementById("displayLocation").textContent = location;
        document.getElementById("dailyRate").textContent = `‚Çπ${dailyRate}`;
        document.getElementById(
          "displayDuration"
        ).textContent = `${days} day(s)`;
        document.getElementById("displayInsurance").textContent =
          insuranceCheckbox.checked
            ? `‚Çπ${bikeData.insurancePerDay}/day`
            : "Not included";
        document.getElementById("displayDelivery").textContent =
          deliveryRequiredCheckbox.checked
            ? `‚Çπ${bikeData.deliveryCharge}`
            : "Not required";
        document.getElementById("totalAmount").textContent = totalAmount;

        document.getElementById("bikeInfo").style.display = "block";
      }

      // Form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const selectedVehicle = document.querySelector(
          'input[name="vehicle"]:checked'
        );
        if (!selectedVehicle) {
          alert("Please select a vehicle");
          return;
        }

        const vehicleDiv = selectedVehicle.closest(".vehicle-selection");
        const fromDate = new Date(fromDateInput.value);
        const toDate = new Date(toDateInput.value);

        if (fromDate >= toDate) {
          alert("To date must be after from date");
          return;
        }

        const bookingData = {
          userId: document.getElementById("userId").value,
          vehicles: [
            {
              bikeId: vehicleDiv.dataset.bikeId,
              vehicleNumber: vehicleDiv.dataset.vehicleNumber,
            },
          ],
          fromDate: fromDate.toISOString(),
          toDate: toDate.toISOString(),
          features: {
            pickupLocation:
              document.getElementById("pickupLocation").value || undefined,
            dropLocation:
              document.getElementById("dropLocation").value || undefined,
            specialRequests:
              document.getElementById("specialRequests").value || undefined,
            insuranceIncluded: insuranceCheckbox.checked,
            deliveryRequired: deliveryRequiredCheckbox.checked,
            deliveryAddress: deliveryRequiredCheckbox.checked
              ? document.getElementById("deliveryAddress").value
              : undefined,
            emergencyContact:
              document.getElementById("emergencyContact").value || undefined,
          },
          customerNotes:
            document.getElementById("customerNotes").value || undefined,
        };

        await processPayment(bookingData);
      });

      // Process payment
      async function processPayment(bookingData) {
        try {
          showLoading();

          // Create order
          const orderResponse = await fetch(
            `${API_BASE_URL}/booking/create-order`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(bookingData),
            }
          );

          if (!orderResponse.ok) {
            const errorData = await orderResponse.json();
            throw new Error(errorData.message || "Failed to create order");
          }

          const orderData = await orderResponse.json();
          hideLoading();

          // Initialize Razorpay
          const options = {
            key: orderData.data.razorpayKey || RAZORPAY_KEY,
            amount: orderData.data.booking.pricing.totalAmount * 100, // Amount in paise
            currency: "INR",
            name: "Bike Booking Service",
            description: `Booking for Royal Enfield Himalayan 411`,
            order_id: orderData.data.orderId,
            handler: function (response) {
              verifyPayment(response, orderData.data.booking.bookingId);
            },
            prefill: {
              name: "Test User",
              email: "test@example.com",
              contact: "9999999999",
            },
            theme: {
              color: "#4CAF50",
            },
            modal: {
              ondismiss: function () {
                console.log("Payment cancelled by user");
              },
            },
          };

          const rzp = new Razorpay(options);
          rzp.open();
        } catch (error) {
          console.error("Payment processing error:", error);
          hideLoading();
          showFailure(error.message);
        }
      }

      // Verify payment
      async function verifyPayment(response, bookingId) {
        try {
          showLoading();
          console.log("Payment verification response:", response);
          const verificationData = {
            bookingId: bookingId,
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature,
          };

          const verifyResponse = await fetch(
            `${API_BASE_URL}/booking/confirmBooking`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(verificationData),
            }
          );

          hideLoading();

          if (verifyResponse.ok) {
            const result = await verifyResponse.json();
            showSuccess(response.razorpay_payment_id, bookingId, result);
          } else {
            const errorData = await verifyResponse.json();
            showFailure(errorData.message || "Payment verification failed");
          }
        } catch (error) {
          console.error("Payment verification error:", error);
          hideLoading();
          showFailure("Payment verification failed");
        }
      }

      // UI State Management
      function showLoading() {
        document.getElementById("bookingForm").style.display = "none";
        document.getElementById("loadingState").style.display = "block";
        document.getElementById("successPage").style.display = "none";
        document.getElementById("failurePage").style.display = "none";
      }

      function hideLoading() {
        document.getElementById("loadingState").style.display = "none";
      }

      function showSuccess(paymentId, bookingId, result) {
        document.getElementById("bookingForm").style.display = "none";
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successPage").style.display = "block";
        document.getElementById("failurePage").style.display = "none";

        // Update success page details
        document.getElementById("successBookingId").textContent = bookingId;
        document.getElementById("successPaymentId").textContent = paymentId;
        document.getElementById("successBikeModel").textContent =
          "Royal Enfield Himalayan 411";

        const selectedVehicle = document.querySelector(
          'input[name="vehicle"]:checked'
        );
        if (selectedVehicle) {
          const vehicleDiv = selectedVehicle.closest(".vehicle-selection");
          document.getElementById("successVehicleNumber").textContent =
            vehicleDiv.dataset.vehicleNumber;
        }

        document.getElementById("successAmount").textContent = `‚Çπ${
          document.getElementById("totalAmount").textContent
        }`;
      }

      function showFailure(errorMessage = "Payment processing failed") {
        document.getElementById("bookingForm").style.display = "none";
        document.getElementById("loadingState").style.display = "none";
        document.getElementById("successPage").style.display = "none";
        document.getElementById("failurePage").style.display = "block";

        document.getElementById("errorMessage").textContent = errorMessage;
      }

      function resetForm() {
        document.getElementById("bookingForm").style.display = "block";
        document.getElementById("successPage").style.display = "none";
        document.getElementById("failurePage").style.display = "none";
        document.getElementById("loadingState").style.display = "none";

        // Reset form
        form.reset();
        document.getElementById("userId").value = "USR1754833148052000";

        // Reset dates
        const now = new Date();
        const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
        fromDateInput.value = now.toISOString().slice(0, 16);
        toDateInput.value = tomorrow.toISOString().slice(0, 16);

        document.getElementById("bikeInfo").style.display = "none";
        document.getElementById("totalAmount").textContent = "0";
        document.querySelectorAll(".vehicle-selection").forEach((div) => {
          div.classList.remove("selected");
        });
        deliveryAddressGroup.style.display = "none";
      }

      // Initialize
      updateBookingSummary();
    </script>
  </body>
</html>
